# 流量导入


## 目前网络架构

下图描述了常见网络拓扑: 

![ll1. 常见的网络拓扑结构](http://www.z4a.net/images/2018/11/29/ll1.jpg)

- 外网的 `http`/`https` 数据首先达到企业的边缘路由设备. 
- 所有流量会导入到 `Load Balance` (负载均衡, 后面简称 `LB`) . `LB`会根据配置作一定的路由, 并将相应的 `http/https` 流量指向实际的服务器集群. 
- 图中右下角的集群提供 `http` 服务; 右上角的集群提供` https` 服务, 企业的`SSL`证书装在每台 物理机器的应用服务器上 (`IIS`/`Apache`/`Nginx`) , 由应用服务器进行 `https` 的终结. 实际中同一集群可能同时支持 `http` 和 `https` 流量. 

## https 流量解析
最安全和简单的方法是通过 `LB` 进行 `https` 终结, 如下图所示: 

![ll2. https流量解析](http://www.z4a.net/images/2018/11/30/ll2.jpg)

解析流程: 

- 将企业的` SSL` 证书绑定到` LB `上, 这样在` LB`上终结了` SSL`, 从 `LB `上出来的流量都是 `http` 流量. 
- 内部所有集群都提供的是` http` 服务, 不需要在每台服务器上去部署`SSL` 证书. 
- 部署单个 `TH-Nebula`流量解析系统, 解析所有 `http` 流量. 

这种部署方式比较简单, 简化了企业内部的拓扑结构, 同时能保留完全向前保密的` SSL` 模式, 并且只需要一份 `TH-Nebula`流量分析系统. 

## 流量导入

`TH-Nebula`流量导入使用的是系统中的`sniffer`组件, `sniffer`是威胁猎人开发适用于不允许镜像 (或者云平台)  情况下复制待分析流量的工具. 该工具用软件方式模拟物理机房中的交换机流量镜像的部分功能, 可以将宿主机的指定流量通过` IP `层传输到指定的服务器上. 

优点: 
- 通过软件的方式模拟硬件功能, 适合在物理环境下无法正常获取流量的情况下, 作为补充方式来尽可能达到同样的目的. 
- 资源消耗非常低, 流量的还原分析功能都在别的服务器上运行, `sniffer` 只消耗少量 `CPU`资源作包转发. 
- 零侵入, 对客户的程序和组件无任何影响. 

